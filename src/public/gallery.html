<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Galerie d'images</title>
  </head>
  <body>
    <h1>Galerie d'images</h1>
    <div id="gallery"></div>

    <script>
      // Vérification du token au chargement
      window.addEventListener("load", function () {
        fetch("/auth/verify-token", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          credentials: "include", // Inclure les cookies
        })
          .then((response) => {
            if (!response.ok) {
              window.location.href = "/";
            }
          })
          .catch((err) => {
            console.error("Erreur lors de la vérification du token :", err);
            window.location.href = "/";
          });
      });

      // Récupérer les images et afficher la galerie
      fetch("/auth/images", {
        credentials: "include", // Inclure les cookies
      })
        .then((response) => response.json())
        .then((data) => {
          const galleryDiv = document.getElementById("gallery");

          data.forEach((image) => {
            const imgContainer = document.createElement("div");
            const img = document.createElement("img");
            const likeButton = document.createElement("button");
            const commentForm = document.createElement("form");
            const commentInput = document.createElement("input");
            const commentButton = document.createElement("button");
            const commentSection = document.createElement("div");

            img.src = image.image_path;
            img.width = 200;

            likeButton.textContent = `Like (${image.likes || 0})`;
            likeButton.addEventListener("click", () => {
              fetch(`/auth/like/${image.id}`, {
                method: "POST",
                credentials: "include", // Inclure les cookies
              })
                .then((response) => response.json())
                .then((data) => {
                  likeButton.textContent = `Like (${data.likes})`;
                });
            });

            // Formulaire pour ajouter un commentaire
            commentInput.placeholder = "Ajouter un commentaire...";
            commentButton.textContent = "Envoyer";
            commentButton.type = "submit";
            commentForm.appendChild(commentInput);
            commentForm.appendChild(commentButton);

            // Gestion des commentaires : soumettre un commentaire
            commentForm.addEventListener("submit", (e) => {
              e.preventDefault();
              const comment = commentInput.value;
              if (comment) {
                fetch(`/auth/comment/${image.id}`, {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                  },
                  credentials: "include", // Inclure les cookies
                  body: JSON.stringify({ comment }),
                })
                  .then((response) => {
                    if (!response.ok) {
                      throw new Error("Erreur lors de l'ajout du commentaire");
                    }
                    return response.json();
                  })
                  .then((data) => {
                    console.log("Commentaire ajouté :", data);
                    commentInput.value = ""; // Réinitialiser le champ de commentaire
                    loadComments(image.id, commentSection); // Recharger les commentaires après ajout
                  })
                  .catch((error) => {
                    console.error(
                      "Erreur lors de l'ajout du commentaire :",
                      error
                    );
                  });
              }
            });

            imgContainer.appendChild(img);
            imgContainer.appendChild(likeButton);
            imgContainer.appendChild(commentForm);
            imgContainer.appendChild(commentSection);
            galleryDiv.appendChild(imgContainer);

            // Charger les commentaires pour cette image
            loadComments(image.id, commentSection);
          });
        })
        .catch((error) => {
          console.error("Erreur lors de la récupération des images :", error);
        });

      // Fonction pour charger les commentaires d'une image
      function loadComments(imageId, commentSection) {
        commentSection.innerHTML = ""; // Effacer les anciens commentaires
        fetch(`/auth/comments/${imageId}`, {
          credentials: "include", // Inclure les cookies
        })
          .then((response) => response.json())
          .then((comments) => {
            comments.forEach((comment) => {
              const commentDiv = document.createElement("div");
              commentDiv.textContent = `${comment.email} : ${comment.comment} (le ${comment.created_at})`;
              commentSection.appendChild(commentDiv);
            });
          })
          .catch((error) => {
            console.error(
              "Erreur lors de la récupération des commentaires :",
              error
            );
          });
      }
    </script>
    <script src="/logout.js"></script>
  </body>
</html>
