<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Galerie d'images</title>
    <style>
      body {
        display: grid;
        grid-template-areas:
          "header"
          "main"
          "footer";
        grid-template-rows: auto 1fr auto;
        height: 100vh;
        margin: 0;
      }
      header {
        grid-area: header;
        background-color: #333;
        color: white;
        padding: 1rem;
        text-align: center;
        position: relative;
      }
      footer {
        grid-area: footer;
        background-color: #333;
        color: white;
        text-align: center;
        padding: 1rem;
      }
      main {
        grid-area: main;
        padding: 1rem;
        background-color: #f4f4f4;
        overflow-y: auto;
      }
      .logout-btn {
        position: absolute;
        top: 50%;
        right: 1rem;
        transform: translateY(-50%);
        background-color: red;
        color: white;
        padding: 10px 20px;
        border: none;
        cursor: pointer;
        border-radius: 5px;
      }
      img {
        max-width: 100%;
        height: auto;
        margin-bottom: 10px;
        display: block;
      }
      button {
        margin-top: 10px;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>Galerie d'images</h1>
      <button class="logout-btn">Déconnexion</button>
    </header>

    <main>
      <div id="gallery"></div>
    </main>

    <footer>
      <p>Camagru © 2024</p>
    </footer>

    <script>
      // Vérification du token au chargement
      window.addEventListener("load", function () {
        fetch("/auth/verify-token", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          credentials: "include", // Inclure les cookies
        })
          .then((response) => {
            if (!response.ok) {
              window.location.href = "/";
            }
          })
          .catch((err) => {
            console.error("Erreur lors de la vérification du token :", err);
            window.location.href = "/";
          });
      });

      // Fonction de déconnexion
      document.querySelector(".logout-btn").addEventListener("click", () => {
        fetch("/auth/logout", {
          method: "POST",
          credentials: "include", // Inclure les cookies
        })
          .then((response) => {
            if (response.ok) {
              window.location.href = "/"; // Rediriger vers la page d'accueil
            } else {
              throw new Error("Erreur lors de la déconnexion");
            }
          })
          .catch((error) => {
            console.error("Erreur lors de la déconnexion :", error);
          });
      });

      // Récupérer les images et afficher la galerie
      fetch("/auth/images", {
        credentials: "include", // Inclure les cookies
      })
        .then((response) => response.json())
        .then((data) => {
          const galleryDiv = document.getElementById("gallery");

          data.forEach((image) => {
            const imgContainer = document.createElement("div");
            const img = document.createElement("img");
            const likeButton = document.createElement("button");
            const commentForm = document.createElement("form");
            const commentInput = document.createElement("input");
            const commentButton = document.createElement("button");
            const commentSection = document.createElement("div");

            img.src = image.image_path;
            img.width = 200;

            // Charger l'état du like (vérifier si l'utilisateur a liké l'image)
            fetch(`/auth/like-status/${image.id}`, {
              credentials: "include", // Inclure les cookies
            })
              .then((response) => response.json())
              .then((likeData) => {
                if (likeData.liked) {
                  likeButton.textContent = `Unlike (${image.likes})`; // Si déjà liké
                } else {
                  likeButton.textContent = `Like (${image.likes})`; // Si pas liké
                }
              });

            // Gestion des likes (ajouter ou retirer un like)
            likeButton.addEventListener("click", () => {
              fetch(`/auth/like/${image.id}`, {
                method: "POST",
                credentials: "include", // Inclure les cookies
              })
                .then((response) => response.json())
                .then((data) => {
                  // Mettre à jour le bouton après un like/unlike
                  fetch(`/auth/like-status/${image.id}`, {
                    credentials: "include", // Inclure les cookies
                  })
                    .then((response) => response.json())
                    .then((likeData) => {
                      if (likeData.liked) {
                        likeButton.textContent = `Unlike (${likeData.likes})`;
                      } else {
                        likeButton.textContent = `Like (${likeData.likes})`;
                      }
                    });
                });
            });

            // Formulaire pour ajouter un commentaire
            commentInput.placeholder = "Ajouter un commentaire...";
            commentButton.textContent = "Envoyer";
            commentButton.type = "submit";
            commentForm.appendChild(commentInput);
            commentForm.appendChild(commentButton);

            // Gestion des commentaires : soumettre un commentaire
            commentForm.addEventListener("submit", (e) => {
              e.preventDefault();
              const comment = commentInput.value;
              if (comment) {
                fetch(`/auth/comment/${image.id}`, {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                  },
                  credentials: "include", // Inclure les cookies
                  body: JSON.stringify({ comment }),
                })
                  .then((response) => response.json())
                  .then((data) => {
                    commentInput.value = ""; // Réinitialiser le champ de commentaire
                    loadComments(image.id, commentSection); // Recharger les commentaires après ajout
                  });
              }
            });

            imgContainer.appendChild(img);
            imgContainer.appendChild(likeButton);
            imgContainer.appendChild(commentForm);
            imgContainer.appendChild(commentSection);
            galleryDiv.appendChild(imgContainer);

            // Charger les commentaires pour cette image
            loadComments(image.id, commentSection);
          });
        })
        .catch((error) => {
          console.error("Erreur lors de la récupération des images :", error);
        });

      // Fonction pour charger les commentaires d'une image
      function loadComments(imageId, commentSection) {
        commentSection.innerHTML = ""; // Effacer les anciens commentaires
        fetch(`/auth/comments/${imageId}`, {
          credentials: "include", // Inclure les cookies
        })
          .then((response) => response.json())
          .then((comments) => {
            comments.forEach((comment) => {
              const commentDiv = document.createElement("div");
              commentDiv.textContent = `${comment.email} : ${comment.comment} (le ${comment.created_at})`;
              commentSection.appendChild(commentDiv);
            });
          })
          .catch((error) => {
            console.error(
              "Erreur lors de la récupération des commentaires :",
              error
            );
          });
      }
    </script>
  </body>
</html>
