<!DOCTYPE html>
<html lang="en">
  <head>
    <link rel="icon" type="image/x-icon" href="/favicon_cam.ico" />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Galerie d'images</title>
    <style>
      body {
        display: grid;
        grid-template-areas:
          "header"
          "main"
          "footer";
        grid-template-rows: auto 1fr auto;
        height: 100vh;
        margin: 0;
      }

      header {
        grid-area: header;
        background-color: #333;
        color: white;
        padding: 1rem;
        text-align: center;
        position: relative;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .nav-links {
        display: flex;
        gap: 20px;
      }

      .nav-links a {
        color: white;
        text-decoration: none;
        font-size: 1.2rem;
        padding: 10px 15px;
        background-color: transparent;
        border: none;
        cursor: pointer;
      }

      .nav-links a.active {
        background-color: #555;
        border-radius: 5px;
      }

      footer {
        grid-area: footer;
        background-color: #333;
        color: white;
        text-align: center;
        padding: 1rem;
      }

      main {
        grid-area: main;
        padding: 1rem;
        background-color: #f4f4f4;
        overflow-y: auto;
      }

      .logout-btn {
        background-color: red;
        color: white;
        padding: 10px 20px;
        border: none;
        cursor: pointer;
        border-radius: 5px;
      }

      img {
        max-width: 100%;
        height: auto;
        margin-bottom: 10px;
        display: block;
      }

      .image-container {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 20px;
        border-bottom: 1px solid #ccc;
        padding-bottom: 10px;
      }

      .username {
        font-weight: bold;
        margin-left: 20px;
      }

      button {
        margin-top: 10px;
      }

      .pagination {
        text-align: center;
        margin-top: 20px;
      }

      .pagination button {
        padding: 10px 15px;
        margin: 0 5px;
        background-color: #333;
        color: white;
        border: none;
        cursor: pointer;
      }

      /* Responsive Design */
      @media screen and (max-width: 768px) {
        body {
          grid-template-areas:
            "header"
            "main"
            "footer";
          grid-template-columns: 1fr;
          grid-template-rows: auto 1fr auto;
        }

        header {
          flex-direction: column;
        }

        .nav-links {
          flex-direction: column;
          align-items: center;
          gap: 10px; /* Réduire l'espace entre les liens */
        }

        .nav-links a {
          padding: 10px;
          width: 100%;
          text-align: center;
        }

        main {
          padding: 0.5rem;
        }

        .image-container {
          flex-direction: column;
          align-items: center;
          justify-content: center;
          text-align: center;
        }

        img {
          width: 100%; /* L'image prend toute la largeur sur mobile */
          max-width: 100%;
          height: auto;
        }

        .pagination {
          display: flex;
          flex-direction: column;
          align-items: center;
        }

        .pagination button {
          width: 100%;
          margin-bottom: 10px; /* Ajouter un espace entre les boutons de pagination */
        }

        .logout-btn {
          width: 100%;
          margin-top: 10px;
          padding: 10px 0; /* Ajuster la hauteur du bouton */
          text-align: center;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <div class="nav-links">
        <a href="/gallery" id="gallery-link" class="active">Gallery</a>
        <a href="/camera" id="dashboard-link">Dashboard</a>
        <a href="/settings" id="settings-link">Settings</a>
      </div>
      <button class="logout-btn">Déconnexion</button>
    </header>

    <main>
      <div id="gallery"></div>
      <div class="pagination">
        <button id="prev-page" disabled>Précédent</button>
        <button id="next-page">Suivant</button>
      </div>
    </main>

    <footer>
      <p>Camagru © 2024</p>
    </footer>

    <script>
      // Marquer le lien actif
      const currentUrl = window.location.pathname;
      if (currentUrl === "/gallery") {
        document.getElementById("gallery-link").classList.add("active");
      } else if (currentUrl === "/camera") {
        document.getElementById("dashboard-link").classList.add("active");
      } else if (currentUrl === "/settings") {
        document.getElementById("settings-link").classList.add("active");
      }

      let currentPage = 1;
      const imagesPerPage = 5; // Limite d'images par page

      // Vérification du token au chargement
      window.addEventListener("load", function () {
        fetch("/auth/verify-token", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          credentials: "include", // Inclure les cookies
        })
          .then((response) => {
            if (!response.ok) {
              window.location.href = "/";
            }
          })
          .catch((err) => {
            console.error("Erreur lors de la vérification du token :", err);
            window.location.href = "/";
          });

        loadImages(currentPage); // Charger les images au chargement de la page
      });

      // Fonction de déconnexion
      document.querySelector(".logout-btn").addEventListener("click", () => {
        fetch("/auth/logout", {
          method: "POST",
          credentials: "include", // Inclure les cookies
        })
          .then((response) => {
            if (response.ok) {
              window.location.href = "/"; // Rediriger vers la page d'accueil
            } else {
              throw new Error("Erreur lors de la déconnexion");
            }
          })
          .catch((error) => {
            console.error("Erreur lors de la déconnexion :", error);
          });
      });

      // Récupérer les images et afficher la galerie avec pagination
      function loadImages(page) {
        fetch(`/auth/images?page=${page}&limit=${imagesPerPage}`, {
          credentials: "include", // Inclure les cookies
        })
          .then((response) => response.json())
          .then((data) => {
            const galleryDiv = document.getElementById("gallery");
            galleryDiv.innerHTML = ""; // Vider la galerie avant de recharger

            if (data.images.length === 0) {
              galleryDiv.innerHTML = "<p>Aucune image à afficher.</p>";
            } else {
              data.images.forEach((image) => {
                const imgContainer = document.createElement("div");
                imgContainer.classList.add("image-container");

                const img = document.createElement("img");
                img.src = image.image_path;
                img.width = 200;

                // Vérifie ici que l'email est bien récupéré et affiché
                const email = document.createElement("div");
                email.classList.add("username");
                email.textContent = `Par : ${
                  image.email ? image.email : "Inconnu"
                }`; // Afficher l'email

                const likeButton = document.createElement("button");
                const commentForm = document.createElement("form");
                const commentInput = document.createElement("input");
                const commentButton = document.createElement("button");
                const commentSection = document.createElement("div");

                // Charger l'état du like (vérifier si l'utilisateur a liké l'image)
                fetch(`/auth/like-status/${image.id}`, {
                  credentials: "include", // Inclure les cookies
                })
                  .then((response) => response.json())
                  .then((likeData) => {
                    likeButton.textContent = likeData.liked
                      ? `Unlike (${image.likes})`
                      : `Like (${image.likes})`;
                  });

                // Gestion des likes (ajouter ou retirer un like)
                likeButton.addEventListener("click", () => {
                  fetch(`/auth/like/${image.id}`, {
                    method: "POST",
                    credentials: "include", // Inclure les cookies
                  })
                    .then((response) => response.json())
                    .then((data) => {
                      // Mettre à jour le bouton après un like/unlike
                      fetch(`/auth/like-status/${image.id}`, {
                        credentials: "include", // Inclure les cookies
                      })
                        .then((response) => response.json())
                        .then((likeData) => {
                          likeButton.textContent = likeData.liked
                            ? `Unlike (${likeData.likes})`
                            : `Like (${likeData.likes})`;
                        });
                    });
                });

                // Formulaire pour ajouter un commentaire
                commentInput.placeholder = "Ajouter un commentaire...";
                commentButton.textContent = "Envoyer";
                commentButton.type = "submit";
                commentForm.appendChild(commentInput);
                commentForm.appendChild(commentButton);

                // Gestion des commentaires : soumettre un commentaire
                commentForm.addEventListener("submit", (e) => {
                  e.preventDefault();
                  const comment = commentInput.value;
                  if (comment) {
                    fetch(`/auth/comment/${image.id}`, {
                      method: "POST",
                      headers: {
                        "Content-Type": "application/json",
                      },
                      credentials: "include", // Inclure les cookies
                      body: JSON.stringify({ comment }),
                    })
                      .then((response) => response.json())
                      .then((data) => {
                        commentInput.value = ""; // Réinitialiser le champ de commentaire
                        loadComments(image.id, commentSection); // Recharger les commentaires après ajout
                      });
                  }
                });

                imgContainer.appendChild(img);
                imgContainer.appendChild(email);
                galleryDiv.appendChild(imgContainer);
                imgContainer.appendChild(likeButton);
                imgContainer.appendChild(commentForm);
                imgContainer.appendChild(commentSection);

                // Charger les commentaires pour cette image
                loadComments(image.id, commentSection);
              });

              // Mettre à jour l'état des boutons de pagination
              const prevButton = document.getElementById("prev-page");
              const nextButton = document.getElementById("next-page");

              prevButton.disabled = page === 1;
              nextButton.disabled = !data.hasMore;
            }
          })
          .catch((error) => {
            console.error("Erreur lors de la récupération des images :", error);
          });
      }

      // Fonction pour charger les commentaires d'une image
      function loadComments(imageId, commentSection) {
        commentSection.innerHTML = ""; // Effacer les anciens commentaires
        fetch(`/auth/comments/${imageId}`, {
          credentials: "include", // Inclure les cookies
        })
          .then((response) => response.json())
          .then((comments) => {
            comments.forEach((comment) => {
              const commentDiv = document.createElement("div");
              commentDiv.textContent = `${comment.email} : ${comment.comment}`;
              commentSection.appendChild(commentDiv);
            });
          })
          .catch((error) => {
            console.error(
              "Erreur lors de la récupération des commentaires :",
              error
            );
          });
      }

      // Gestion de la pagination
      document.getElementById("prev-page").addEventListener("click", () => {
        if (currentPage > 1) {
          currentPage--;
          loadImages(currentPage);
        }
      });

      document.getElementById("next-page").addEventListener("click", () => {
        currentPage++;
        loadImages(currentPage);
      });
    </script>
  </body>
</html>
