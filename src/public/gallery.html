<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Galerie d'images</title>
  </head>
  <body>
    <h1>Galerie d'images</h1>
    <div id="gallery"></div>

    <script>
      window.onload = function () {
        const token = localStorage.getItem("token");
        if (!token) {
          window.location.href = "/";
        }

        fetch("/auth/verify-token", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
        })
          .then((response) => {
            if (!response.ok) {
              localStorage.removeItem("token");
              window.location.href = "/";
            }
          })
          .catch((err) => {
            console.error("Erreur lors de la vérification du token :", err);
            localStorage.removeItem("token");
            window.location.href = "/";
          });
      };

      fetch("/auth/images")
        .then((response) => response.json())
        .then((data) => {
          const galleryDiv = document.getElementById("gallery");
          data.forEach((image) => {
            const imgContainer = document.createElement("div");
            const img = document.createElement("img");
            const likeButton = document.createElement("button");

            img.src = image.image_path;
            img.width = 200;

            likeButton.textContent = `Like (${image.likes || 0})`;
            likeButton.addEventListener("click", () => {
              fetch(`/auth/like/${image.id}`, { method: "POST" })
                .then((response) => response.json())
                .then((data) => {
                  likeButton.textContent = `Like (${data.likes})`;
                });
            });

            imgContainer.appendChild(img);
            imgContainer.appendChild(likeButton);
            galleryDiv.appendChild(imgContainer);
          });
        })
        .catch((error) => {
          console.error("Erreur lors de la récupération des images :", error);
        });
    </script>
    <script src="/logout.js"></script>
  </body>
</html>
