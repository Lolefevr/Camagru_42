<!DOCTYPE html>
<html lang="en">
  <head>
    <link
      rel="icon"
      type="image/x-icon"
      href="/src/public/favicon_cam.ico?v=1"
    />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Réinitialiser le mot de passe</title>
    <style>
      body {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        margin: 0;
        background-color: #f4f4f4;
      }
      .container {
        width: 100%;
        max-width: 400px;
        padding: 20px;
        background-color: white;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        border-radius: 8px;
      }
      h2 {
        text-align: center;
        margin-bottom: 20px;
      }
      label {
        font-weight: bold;
        display: block;
        margin-bottom: 5px;
      }
      input {
        width: 100%;
        padding: 10px;
        margin-bottom: 15px;
        border: 1px solid #ddd;
        border-radius: 4px;
      }
      button {
        width: 100%;
        padding: 10px;
        background-color: #333;
        color: white;
        border: none;
        cursor: pointer;
        border-radius: 5px;
        font-size: 1rem;
      }
      button:hover {
        background-color: #555;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h2>Réinitialiser le mot de passe</h2>
      <form id="resetPasswordForm">
        <input type="hidden" id="token" />
        <label for="newPassword">Nouveau mot de passe :</label>
        <input type="password" id="newPassword" required />
        <label for="confirmPassword">Confirmer le mot de passe :</label>
        <input type="password" id="confirmPassword" required />
        <button type="submit">Réinitialiser le mot de passe</button>
      </form>
    </div>

    <script>
      // Fonction pour récupérer le token CSRF
      async function getCsrfToken() {
        try {
          const response = await fetch("/auth/csrf-token", {
            credentials: "include",
          });
          if (!response.ok)
            throw new Error("Échec de l'obtention du token CSRF");
          const data = await response.json();
          return data.csrfToken;
        } catch (error) {
          console.error("Erreur lors de la récupération du token CSRF:", error);
          alert(
            "Erreur lors de la récupération du token CSRF. Veuillez réessayer plus tard."
          );
          throw error;
        }
      }

      // Fonction de validation de mot de passe
      function validatePassword(password) {
        const minLength = 12;
        const upperCaseRegex = /[A-Z]/;
        const lowerCaseRegex = /[a-z]/;
        const numberRegex = /[0-9]/;
        const specialCharRegex = /[!@#$%^&*(),.?":{}|<>]/;

        if (password.length < minLength) {
          return {
            isValid: false,
            message: `Le mot de passe doit contenir au moins ${minLength} caractères.`,
          };
        }
        if (!upperCaseRegex.test(password)) {
          return {
            isValid: false,
            message:
              "Le mot de passe doit contenir au moins une lettre majuscule.",
          };
        }
        if (!lowerCaseRegex.test(password)) {
          return {
            isValid: false,
            message:
              "Le mot de passe doit contenir au moins une lettre minuscule.",
          };
        }
        if (!numberRegex.test(password)) {
          return {
            isValid: false,
            message: "Le mot de passe doit contenir au moins un chiffre.",
          };
        }
        if (!specialCharRegex.test(password)) {
          return {
            isValid: false,
            message:
              "Le mot de passe doit contenir au moins un caractère spécial.",
          };
        }

        return { isValid: true, message: "" };
      }

      // Extraire le token de l'URL
      const urlParams = new URLSearchParams(window.location.search);
      const token = urlParams.get("token");
      document.getElementById("token").value = token;

      // Gestion de la soumission du formulaire avec le token CSRF
      document
        .getElementById("resetPasswordForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();
          const newPassword = document.getElementById("newPassword").value;
          const confirmPassword =
            document.getElementById("confirmPassword").value;

          // Validation de la sécurité du mot de passe
          const passwordValidation = validatePassword(newPassword);
          if (!passwordValidation.isValid) {
            alert(passwordValidation.message);
            return;
          }

          if (newPassword !== confirmPassword) {
            alert("Les mots de passe ne correspondent pas.");
            return;
          }

          try {
            const csrfToken = await getCsrfToken(); // Récupérer le token CSRF
            const response = await fetch("/auth/reset-password", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "CSRF-Token": csrfToken, // Inclure le token CSRF
              },
              credentials: "include",
              body: JSON.stringify({ token, newPassword }),
            });

            const data = await response.json();
            alert(data.message);
            if (data.success) {
              window.location.href = "/"; // Redirige vers la page de connexion
            }
          } catch (error) {
            console.error("Erreur:", error);
          }
        });
    </script>
  </body>
</html>
