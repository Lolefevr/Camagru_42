<!DOCTYPE html>
<html lang="en">
  <head>
    <link rel="icon" type="image/x-icon" href="/favicon_cam.ico" />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Camagru - Settings</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="flex flex-col min-h-screen bg-gray-100">
    <!-- Header -->
    <header
      class="bg-gray-800 text-white p-4 flex justify-between items-center"
    >
      <nav class="flex space-x-4">
        <a href="/gallery" class="hover:text-gray-300">Gallery</a>
        <a href="/camera" class="hover:text-gray-300">Dashboard</a>
        <a href="/settings" class="text-gray-300 font-semibold">Settings</a>
      </nav>
      <button
        class="logout-btn bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded"
      >
        Déconnexion
      </button>
    </header>

    <!-- Main content -->
    <main
      class="flex-1 p-6 grid gap-6 grid-cols-1 md:grid-cols-2 lg:grid-cols-3"
    >
      <!-- Préférences de notification avec switch -->
      <section class="bg-white p-4 rounded-lg shadow-md">
        <h3 class="text-xl font-bold mb-4 border-b pb-2">
          Préférences de notification
        </h3>
        <form id="notificationPreferenceForm">
          <div class="flex items-center justify-between">
            <span
              >Recevoir des notifications par email pour les nouveaux
              commentaires</span
            >
            <label class="relative inline-flex items-center cursor-pointer">
              <input
                type="checkbox"
                class="sr-only peer"
                id="notificationSwitch"
              />
              <div
                class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:bg-blue-500"
              ></div>
              <div
                class="absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition-all peer-checked:translate-x-full"
              ></div>
            </label>
          </div>
          <button
            type="submit"
            class="mt-4 w-full bg-gray-800 text-white py-2 rounded hover:bg-gray-600"
          >
            Enregistrer les préférences
          </button>
        </form>
      </section>

      <!-- Section Mot de passe oublié -->
      <section class="bg-white p-4 rounded-lg shadow-md">
        <h3 class="text-xl font-bold mb-4 border-b pb-2">
          Mot de passe oublié ?
        </h3>
        <button
          id="forgot-password-btn"
          class="w-full bg-gray-800 text-white py-2 rounded hover:bg-gray-600"
        >
          Réinitialiser le mot de passe
        </button>
        <div id="forgot-password-dialog" class="hidden mt-4">
          <label for="forgot-email" class="block font-semibold"
            >Entrez votre adresse email :</label
          >
          <input
            type="email"
            id="forgot-email"
            placeholder="Votre adresse email"
            class="w-full px-3 py-2 border rounded mt-2"
          />
          <button
            id="send-reset-link"
            class="mt-2 w-full bg-gray-800 text-white py-2 rounded hover:bg-gray-600"
          >
            Envoyer le lien de réinitialisation
          </button>
        </div>
      </section>

      <!-- Informations utilisateur -->
      <section class="bg-white p-4 rounded-lg shadow-md">
        <h3 class="text-xl font-bold mb-4 border-b pb-2">
          Informations de l'utilisateur
        </h3>
        <p>
          Email :
          <span id="user-email" class="text-gray-700">Chargement...</span>
        </p>
        <p>
          Nom d'utilisateur :
          <span id="user-username" class="text-gray-700">Chargement..</span>
        </p>
      </section>

      <!-- Section Modifier son email / pseudo -->
      <section class="bg-white p-4 rounded-lg shadow-md">
        <h3 class="text-xl font-bold mb-4 border-b pb-2">
          Modifier son email / pseudo
        </h3>
        <form id="updateProfileForm" class="space-y-4">
          <div>
            <label for="username" class="block font-semibold"
              >Nom d'utilisateur :</label
            >
            <input
              type="text"
              id="username"
              name="username"
              placeholder="Entrer un nouveau nom d'utilisateur"
              class="w-full px-3 py-2 border rounded"
            />
          </div>
          <div>
            <label for="email" class="block font-semibold">Email :</label>
            <input
              type="email"
              id="email"
              name="email"
              class="w-full px-3 py-2 border rounded"
              placeholder="Nouvelle adresse email"
            />
          </div>
          <button
            type="submit"
            class="w-full bg-gray-800 text-white py-2 rounded hover:bg-gray-600"
          >
            Mettre à jour le profil
          </button>
        </form>
      </section>

      <!-- Section Modifier son mot de passe -->
      <section class="bg-white p-4 rounded-lg shadow-md">
        <h3 class="text-xl font-bold mb-4 border-b pb-2">
          Modifier son mot de passe
        </h3>
        <form id="updatePasswordForm" class="space-y-4">
          <!-- Champ de nom d'utilisateur caché -->
          <input
            type="text"
            id="username_hidden_password"
            name="username"
            autocomplete="username"
            value="NomUtilisateur"
            style="display: none"
            aria-hidden="true"
          />

          <div>
            <label for="current-password" class="block font-semibold">
              Mot de passe actuel :
            </label>
            <input
              type="password"
              id="current-password"
              name="current-password"
              placeholder="Entrer le mot de passe actuel"
              required
              autocomplete="current-password"
              class="w-full px-3 py-2 border rounded"
            />
          </div>

          <div>
            <label for="new-password" class="block font-semibold">
              Nouveau mot de passe :
            </label>
            <input
              type="password"
              id="new-password"
              name="new-password"
              placeholder="Entrer un nouveau mot de passe"
              required
              autocomplete="new-password"
              class="w-full px-3 py-2 border rounded"
            />
          </div>

          <div>
            <label for="confirm-new-password" class="block font-semibold">
              Confirmer le nouveau mot de passe :
            </label>
            <input
              type="password"
              id="confirm-new-password"
              name="confirm-new-password"
              placeholder="Confirmer le nouveau mot de passe"
              required
              autocomplete="new-password"
              class="w-full px-3 py-2 border rounded"
            />
          </div>

          <button
            type="submit"
            class="w-full bg-gray-800 text-white py-2 rounded hover:bg-gray-600"
          >
            Mettre à jour le mot de passe
          </button>
        </form>
      </section>
    </main>

    <footer class="bg-gray-800 text-white text-center p-4">
      <p>Camagru © 2024</p>
    </footer>

    <script>
      async function getCsrfToken() {
        try {
          const response = await fetch("/auth/csrf-token", {
            credentials: "include",
          });
          if (!response.ok)
            throw new Error("Échec de l'obtention du token CSRF");
          const data = await response.json();
          return data.csrfToken;
        } catch (error) {
          console.error("Erreur lors de la récupération du token CSRF:", error);
          alert(
            "Erreur lors de la récupération du token CSRF. Veuillez réessayer plus tard."
          );
          throw error;
        }
      }

      function escapeHTML(str) {
        return str
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      async function handlePostRequest(url, body) {
        const csrfToken = await getCsrfToken();
        const token = localStorage.getItem("token");
        return fetch(url, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
            "CSRF-Token": csrfToken,
          },
          credentials: "include",
          body: JSON.stringify(body),
        });
      }

      document
        .getElementById("notificationPreferenceForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();
          const receiveEmailNotifications = document.getElementById(
            "notificationSwitch"
          ).checked
            ? "1"
            : "0";
          try {
            const response = await handlePostRequest(
              "/auth/update-notification-preference",
              { receiveEmailNotifications }
            );
            const data = await response.json();
            alert(
              data.success
                ? "Préférences de notification mises à jour avec succès."
                : `Erreur: ${data.message}`
            );
          } catch (error) {
            console.error("Erreur:", error);
          }
        });

      document
        .getElementById("updateProfileForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();
          const username = document.getElementById("username").value;
          const email = document.getElementById("email").value;

          try {
            const response = await handlePostRequest("/auth/update-profile", {
              username,
              email,
            });
            const data = await response.json();
            alert(
              data.success
                ? "Profil mis à jour avec succès."
                : `Erreur: ${data.message}`
            );
            if (data.success) {
              loadUserInfo(); // Rafraîchir les informations de l'utilisateur sans recharger la page
            }
          } catch (error) {
            console.error("Erreur:", error);
          }
        });

      document
        .getElementById("updatePasswordForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();
          const currentPassword =
            document.getElementById("current-password").value;
          const newPassword = document.getElementById("new-password").value;
          const confirmNewPassword = document.getElementById(
            "confirm-new-password"
          ).value;

          // Vérifie si le nouveau mot de passe est conforme aux critères de sécurité
          const passwordValidation = validatePassword(newPassword);
          if (!passwordValidation.isValid) {
            alert(passwordValidation.message);
            return; // Arrête la soumission si le mot de passe est invalide
          }

          if (newPassword !== confirmNewPassword) {
            alert("Les nouveaux mots de passe ne correspondent pas.");
            return;
          }

          handlePostRequest("/auth/update-password", {
            currentPassword,
            newPassword,
          })
            .then((response) => response.json())
            .then((data) => {
              alert(
                data.success
                  ? "Mot de passe mis à jour avec succès."
                  : `Erreur: ${data.message}`
              );
            })
            .catch((error) => {
              console.error("Erreur:", error);
            });
        });

      document
        .getElementById("forgot-password-btn")
        .addEventListener("click", () => {
          document
            .getElementById("forgot-password-dialog")
            .classList.toggle("hidden");
        });

      document
        .getElementById("send-reset-link")
        .addEventListener("click", async () => {
          const email = document.getElementById("forgot-email").value;
          try {
            const response = await handlePostRequest("/auth/forgot-password", {
              email,
            });
            const data = await response.json();
            alert(
              data.success
                ? "Un lien de réinitialisation a été envoyé à votre email."
                : `Erreur: ${data.message}`
            );
            if (data.success)
              document
                .getElementById("forgot-password-dialog")
                .classList.add("hidden");
          } catch (error) {
            console.error("Erreur:", error);
          }
        });

      window.addEventListener("load", loadUserInfo);

      function loadUserInfo() {
        fetch("/auth/user-info", {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${localStorage.getItem("token")}`,
          },
          credentials: "include",
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success && data.user) {
              document.getElementById("user-email").textContent = escapeHTML(
                data.user.email
              );
              document.getElementById("user-username").textContent = escapeHTML(
                data.user.username
              );

              // Mettre à jour l'état du switch de notification
              const notificationSwitch =
                document.getElementById("notificationSwitch");
              notificationSwitch.checked =
                data.user.receive_email_notifications == 1;
            }
          })
          .catch((error) =>
            console.error("Erreur lors de la requête utilisateur :", error)
          );
      }

      window.addEventListener("load", loadUserInfo);

      // Fonction de validation de mot de passe
      function validatePassword(password) {
        const minLength = 12;
        const upperCaseRegex = /[A-Z]/;
        const lowerCaseRegex = /[a-z]/;
        const numberRegex = /[0-9]/;
        const specialCharRegex = /[!@#$%^&*(),.?":{}|<>]/;

        if (password.length < minLength) {
          return {
            isValid: false,
            message: `Le mot de passe doit contenir au moins ${minLength} caractères.`,
          };
        }
        if (!upperCaseRegex.test(password)) {
          return {
            isValid: false,
            message:
              "Le mot de passe doit contenir au moins une lettre majuscule.",
          };
        }
        if (!lowerCaseRegex.test(password)) {
          return {
            isValid: false,
            message:
              "Le mot de passe doit contenir au moins une lettre minuscule.",
          };
        }
        if (!numberRegex.test(password)) {
          return {
            isValid: false,
            message: "Le mot de passe doit contenir au moins un chiffre.",
          };
        }
        if (!specialCharRegex.test(password)) {
          return {
            isValid: false,
            message:
              "Le mot de passe doit contenir au moins un caractère spécial.",
          };
        }

        return { isValid: true, message: "" };
      }
    </script>
    <script src="logout.js"></script>
  </body>
</html>
